<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Vistoria - Bombeiros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ícones opcionais -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --vermelho: #b30000;
      --vermelho-escuro: #7a0000;
      --cinza-borda: #e0e0e0;
      --cinza-claro: #f5f5f5;
      --branco-card: rgba(255, 255, 255, 0.95);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background-image: url("fundo.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .conteudo {
      width: 95%;
      max-width: 1100px;
      margin: 24px auto 40px;
      background: var(--branco-card);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .25);
      padding: 28px;
      border: 1px solid rgba(0, 0, 0, .06);
    }

    h1 {
      margin: 0 0 18px;
      text-align: center;
      color: var(--vermelho);
    }

    .top-form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      margin-bottom: 20px;
    }

    .form-group label {
      font-weight: 600;
      color: #222;
      display: block;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      background: #fff;
    }

    .content {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 24px;
    }

    .card {
      background: #fff;
      border: 1px solid var(--cinza-borda);
      border-radius: 12px;
      padding: 18px;
    }

    .categorias {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .categoria {
      border: 1px dashed var(--cinza-borda);
      border-radius: 10px;
      padding: 12px;
      background: #fff;
    }

    .categoria h3 {
      margin: 0 0 10px;
      color: var(--vermelho);
      font-size: 18px;
    }

    /* Cabeçalho de gravidades */
    .grav-header {
      display: grid;
      grid-template-columns: 1fr repeat(4, 1fr);
      gap: 8px;
      font-weight: 700;
      background: #fafafa;
      border: 1px solid var(--cinza-borda);
      border-radius: 8px;
      padding: 8px 10px;
      margin-bottom: 8px;
    }
    .grav-header div { text-align: center; }
    .grav-header .nome-col { text-align: left; }

    /* Linha de item com 4 colunas de gravidade */
    .multa {
      display: grid;
      grid-template-columns: 1fr repeat(4, 1fr);
      gap: 8px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      background: var(--cinza-claro);
      margin-bottom: 8px;
    }

    .multa .nome {
      font-weight: 600;
    }

    .nivel {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .nivel .price {
      font-size: 12px;
      opacity: .85;
      display: block;
      line-height: 1;
    }

    .qty {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .qty button {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: var(--vermelho);
      color: #fff;
      transition: .2s;
    }

    .qty button:hover { background: #a30000; }

    .qty input {
      width: 40px;
      text-align: center;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
    }

    .extrato h2 { margin: 0 0 12px; }

    .extrato-box {
      background: #fff;
      border: 1px solid var(--cinza-borda);
      border-radius: 10px;
      padding: 12px;
      min-height: 160px;
    }

    .extrato-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--cinza-claro);
      margin-bottom: 8px;
    }

    .extrato-item .x { font-weight: 700; color: #444 }

    .total {
      border-top: 2px solid #eee;
      padding-top: 12px;
      margin-top: 10px;
      font-size: 18px;
      font-weight: 700;
      color: var(--vermelho);
    }

    .botoes {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .btn {
      flex: 1;
      background: var(--vermelho);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      cursor: pointer;
      font-weight: 700;
      transition: .2s;
    }

    .btn:hover { background: #a30000; }

    .btn.sec { background: #666; }
    .btn.sec:hover { background: #444; }

    @media (max-width: 1000px) {
      .content { grid-template-columns: 1fr; }
      .top-form { grid-template-columns: 1fr; }
      .grav-header {
        grid-template-columns: 1fr 1fr 1fr;
        row-gap: 6px;
      }
      .grav-header .g-col-3, .grav-header .g-col-4 { display: none; }
      .multa {
        grid-template-columns: 1fr 1fr 1fr;
      }
      .multa .g-3, .multa .g-4 { display: none; }
    }
  </style>
</head>

<body>
  <div class="conteudo">
    <h1>Calculadora de Vistoria - Bombeiros</h1>

    <!-- CAMPOS -->
    <div class="top-form card">
      <div class="form-group">
        <label>Razão Social</label>
        <input id="razao" type="text" placeholder="Ex.: Hospital Norte" oninput="atualizarExtrato()" />
      </div>
      <div class="form-group">
        <label>Responsável Legal</label>
        <input id="respLegal" type="text" placeholder="Ex.: Tony Zera" oninput="atualizarExtrato()" />
      </div>
      <div class="form-group">
        <label>ID</label>
        <input id="idPessoa" type="text" placeholder="Ex.: 108584" oninput="atualizarExtrato()" />
      </div>

      <div class="form-group">
        <label>Cargo</label>
        <input id="cargo" type="text" placeholder="Ex.: Vice Diretor" oninput="atualizarExtrato()" />
      </div>
      <div class="form-group">
        <label>Contato</label>
        <input id="contato" type="text" placeholder="Ex.: 925-719" oninput="atualizarExtrato()" />
      </div>
      <div class="form-group">
        <label>Militar Responsável</label>
        <input id="militar" type="text" placeholder="Assinatura" oninput="atualizarExtrato()" />
      </div>

      <div class="form-group">
        <label>Valor inicial da vistoria (R$)</label>
        <input id="valorInicial" type="text" value="0,00" oninput="formatarMoeda(this); atualizarExtrato();" />
      </div>
    </div>

    <div class="content">
      <!-- CATEGORIAS E MULTAS -->
      <div class="card">
        <h2 style="margin-top:0">Multas</h2>
        <div style="font-size:14px;margin-bottom:8px;opacity:.9">
          <strong>Valores por nível:</strong>
          Baixo = R$ 500.000,00 &nbsp;|&nbsp;
          Médio = R$ 750.000,00 &nbsp;|&nbsp;
          Alto = R$ 1.000.000,00 &nbsp;|&nbsp;
          Gravíssimo = R$ 1.500.000,00
        </div>
        <div id="categorias" class="categorias"></div>
      </div>

      <!-- EXTRATO -->
      <div class="card extrato">
        <h2>Extrato</h2>
        <div id="extrato" class="extrato-box">Nenhuma vistoria registrada.</div>
        <div class="botoes">
          <button class="btn sec" onclick="limparTudo()">Limpar</button>
          <button class="btn" onclick="gerarAlvara()">Gerar Alvará (PDF)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- libs para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /*********** CONFIG ***********/
    const ALVARA_TEMPLATE_SRC = "imagens/alvara_template.png"; // coloque sua imagem do modelo aqui

    // Definição de níveis (ordem importa)
    const LEVELS = [
      { id: 'b', label: 'Baixo', short: 'B', price: 500000 },
      { id: 'm', label: 'Médio', short: 'M', price: 750000 },
      { id: 'a', label: 'Alto', short: 'A', price: 1000000 },
      { id: 'g', label: 'Gravíssimo', short: 'G', price: 1500000 },
    ];

    // Multas por categoria – edite aqui
    const MULTAS = {
      "Saídas de Emergência": [
        { nome: "Rotas de fuga desobstruídas" },
        { nome: "Rotas de fuga iluminadas" },
        { nome: "Piso íntegro e acessível" },
        { nome: "Luminárias de emergência nas rotas" },
        { nome: "Sem saída de emergencia" },
      ],
      "Escadas": [
        { nome: "Escadas desobstruídas" },
        { nome: "Placas e iluminação nas escadas" },
        { nome: "Portas nas escadas" },
      ],
      "Extintores": [
        { nome: "Extintores desobstruídos" },
        { nome: "Extintores sinalizados" },
        { nome: "Extintores em local apropriado" },
        { nome: "Quantidade de extintores (4 ou mais)" },
      ],
      "Sistema de Hidrantes": [
        { nome: "Hidrantes desobstruídos e sinalizados" },
      ],
      "Sprinklers": [
        { nome: "Existência de saída de fumaça / detector de fumaça" },
      ],
      "Iluminação e Sinalização": [
        { nome: "Iluminação de emergência funcionando" },
        { nome: "Sinalização de emergência visível" },
      ],
      "Acessibilidade": [
        { nome: "Rampas para cadeirantes" },
        { nome: "Portas e corredores largos para cadeirantes" },
      ],
      "Outros Itens": [
        { nome: "Material inflamável perto das saídas" },
        { nome: "Cabos ou fios expostos" },
        { nome: "Sem ventilação / entrada de ar" },
        { nome: "Materiais de risco em locais fechados" },
      ]
    };

    const POS = {
      x: 70,
      yStart: 520,
      line: 24,
      sigX: 420,
      sigY: 730
    };

    // Estado das quantidades: { "nome da multa": {b:0,m:0,a:0,g:0} }
    const qtd = {};

    /*********** HELPERS ***********/
    const fmtBRL = (v) => v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    const getPrice = (levelId) => LEVELS.find(l => l.id === levelId).price;

    function parseBRL(str) {
      if (!str) return 0;
      const limpo = str.replace(/\./g, "").replace(",", ".").replace(/[^0-9.]/g, "");
      const num = parseFloat(limpo);
      return isNaN(num) ? 0 : num;
    }

    function formatarMoeda(input) {
      let v = input.value.replace(/[^\d]/g, "");
      if (v === "") { input.value = "0,00"; return; }
      v = (parseInt(v, 10) / 100).toFixed(2).replace(".", ",");
      input.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function ensureItemInit(nome) {
      if (!qtd[nome]) qtd[nome] = { b: 0, m: 0, a: 0, g: 0 };
    }

    /*********** RENDER ***********/
    function montarCategorias() {
      const wrap = document.getElementById("categorias");
      wrap.innerHTML = "";
      Object.entries(MULTAS).forEach(([cat, itens]) => {
        const box = document.createElement("div");
        box.className = "categoria";

        // título da categoria
        const h3 = document.createElement("h3");
        h3.textContent = cat;
        box.appendChild(h3);

        // cabeçalho das colunas
        const head = document.createElement("div");
        head.className = "grav-header";
        head.innerHTML = `
          <div class="nome-col">Item</div>
          <div class="g-col-1">Baixo<br><small>${fmtBRL(getPrice('b'))}</small></div>
          <div class="g-col-2">Médio<br><small>${fmtBRL(getPrice('m'))}</small></div>
          <div class="g-col-3">Alto<br><small>${fmtBRL(getPrice('a'))}</small></div>
          <div class="g-col-4">Gravíssimo<br><small>${fmtBRL(getPrice('g'))}</small></div>
        `;
        box.appendChild(head);

        // linhas
        itens.forEach(item => {
          ensureItemInit(item.nome);

          const linha = document.createElement("div");
          linha.className = "multa";
          linha.innerHTML = `
            <div class="nome">${item.nome}</div>
            ${LEVELS.map((lvl, idx) => `
              <div class="nivel g-${idx+1}">
                <div class="qty">
                  <button type="button" aria-label="diminuir ${lvl.label}" onclick="alterarQtd('${item.nome}','${lvl.id}', -1)">−</button>
                  <input type="text" value="${qtd[item.nome][lvl.id]}" readonly />
                  <button type="button" aria-label="aumentar ${lvl.label}" onclick="alterarQtd('${item.nome}','${lvl.id}', 1)">+</button>
                </div>
              </div>
            `).join("")}
          `;
          box.appendChild(linha);
        });

        wrap.appendChild(box);
      });
    }

    function alterarQtd(nome, levelId, delta) {
      ensureItemInit(nome);
      const cur = qtd[nome][levelId] || 0;
      qtd[nome][levelId] = Math.max(0, cur + delta);
      montarCategorias();
      atualizarExtrato();
    }

    /*********** EXTRATO ***********/
    function atualizarExtrato() {
      const extrato = document.getElementById("extrato");
      const valorInicial = parseBRL(document.getElementById("valorInicial").value);
      const razao = document.getElementById("razao").value.trim();

      const linhas = [];
      let total = valorInicial;

      Object.entries(MULTAS).forEach(([cat, itens]) => {
        itens.forEach(item => {
          ensureItemInit(item.nome);
          const counts = qtd[item.nome];
          const sub =
            counts.b * getPrice('b') +
            counts.m * getPrice('m') +
            counts.a * getPrice('a') +
            counts.g * getPrice('g');

          if (sub > 0) {
            total += sub;
            linhas.push({
              nome: item.nome,
              counts,
              sub
            });
          }
        });
      });

      if (linhas.length === 0 && !razao && valorInicial === 0) {
        extrato.innerHTML = "Nenhuma vistoria registrada.";
        return;
      }

      let html = `
        <div><strong>Razão Social:</strong> ${razao || "N/D"}</div>
        <div><strong>Valor inicial:</strong> ${fmtBRL(valorInicial)}</div>
        <br/>
      `;

      const compactCounts = (c) => {
        const parts = [];
        if (c.b) parts.push(`B×${c.b}`);
        if (c.m) parts.push(`M×${c.m}`);
        if (c.a) parts.push(`A×${c.a}`);
        if (c.g) parts.push(`G×${c.g}`);
        return parts.join(", ");
      };

      linhas.forEach(l => {
        const cc = compactCounts(l.counts);
        html += `
          <div class="extrato-item">
            <span>
              <span class="x">${cc || "—"}</span>
              &nbsp; ${l.nome}
            </span>
            <span><strong>${fmtBRL(l.sub)}</strong></span>
          </div>
        `;
      });

      html += `<div class="total"><strong>Total Final:</strong> ${fmtBRL(total)}</div>`;
      extrato.innerHTML = html;
    }

    function limparTudo() {
      Object.keys(qtd).forEach(k => { qtd[k] = { b: 0, m: 0, a: 0, g: 0 }; });
      document.getElementById("razao").value = "";
      document.getElementById("respLegal").value = "";
      document.getElementById("idPessoa").value = "";
      document.getElementById("cargo").value = "";
      document.getElementById("contato").value = "";
      document.getElementById("militar").value = "";
      document.getElementById("valorInicial").value = "0,00";
      montarCategorias();
      atualizarExtrato();
    }

    /*********** PDF ALVARÁ ***********/
    async function gerarAlvara() {
      const { jsPDF } = window.jspdf;

      const razao = (document.getElementById("razao").value || "").trim();
      const resp = (document.getElementById("respLegal").value || "").trim();
      const id = (document.getElementById("idPessoa").value || "").trim();
      const cargo = (document.getElementById("cargo").value || "").trim();
      const contato = (document.getElementById("contato").value || "").trim();
      const militar = (document.getElementById("militar").value || "").trim();

      const emissao = new Date();
      const renov = new Date(emissao); renov.setDate(emissao.getDate() + 30);
      const fmtDataHora = d => d.toLocaleString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });
      const fmtData = d => d.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric" });

      const pdf = new jsPDF({ unit: "pt", format: "a4" });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      try {
        const imgData = await carregarTemplateComoDataURL(ALVARA_TEMPLATE_SRC);
        pdf.addImage(imgData, "PNG", 0, 0, pageW, pageH);
      } catch (e) {
        console.warn("Falha ao carregar o template:", e);
      }

      pdf.setTextColor(0, 0, 0);
      const LBL_FONT = () => pdf.setFont("helvetica", "normal");
      const VAL_FONT = () => pdf.setFont("helvetica", "bold");

      const writeRow = (label, value, x, y) => {
        LBL_FONT(); pdf.setFontSize(12);
        pdf.text(`${label}: `, x, y);
        const labelWidth = pdf.getTextWidth(`${label}: `);
        VAL_FONT(); pdf.setFontSize(12);
        pdf.text(value || "—", x + labelWidth, y);
      };

      let y = POS.yStart;
      writeRow("Razão social", razao, POS.x, y); y += POS.line;
      writeRow("Data de emissão", fmtDataHora(emissao), POS.x, y); y += POS.line;
      writeRow("Data de renovação", fmtData(renov), POS.x, y); y += POS.line;
      writeRow("Responsável legal", resp, POS.x, y); y += POS.line;
      writeRow("ID", id, POS.x, y); y += POS.line;
      writeRow("Cargo", cargo, POS.x, y); y += POS.line;
      writeRow("Contato", contato, POS.x, y); y += POS.line + 10;

      pdf.setTextColor(178, 34, 34);
      pdf.setFont("times", "italic");
      pdf.setFontSize(26);
      pdf.text(militar || "", POS.sigX, POS.sigY, { align: "center" });
      pdf.setTextColor(0, 0, 0);

      pdf.save(`alvara_${(razao || "empresa").replace(/\s+/g, "_")}.pdf`);
    }

    async function carregarTemplateComoDataURL(src) {
      const res = await fetch(src);
      if (!res.ok) throw new Error(`HTTP ${res.status} ao carregar ${src}`);
      const blob = await res.blob();
      return await new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.readAsDataURL(blob);
      });
    }

    /*********** INIT ***********/
    montarCategorias();
    atualizarExtrato();
  </script>
</body>

</html>
