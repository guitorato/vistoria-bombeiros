<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Vistoria - Bombeiros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ícones opcionais -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --vermelho: #b30000;
      --vermelho-escuro: #7a0000;
      --cinza-borda: #e0e0e0;
      --cinza-claro: #f5f5f5;
      --branco-card: rgba(255, 255, 255, 0.95);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background-image: url("fundo.png");
      /* sua imagem de fundo */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .conteudo {
      width: 95%;
      max-width: 1100px;
      margin: 24px auto 40px;
      background: var(--branco-card);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .25);
      padding: 28px;
      border: 1px solid rgba(0, 0, 0, .06);
    }

    h1 {
      margin: 0 0 18px;
      text-align: center;
      color: var(--vermelho);
    }

    .top-form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      margin-bottom: 20px;
    }

    .form-group label {
      font-weight: 600;
      color: #222;
      display: block;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      background: #fff;
    }

    .content {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 24px;
    }

    .card {
      background: #fff;
      border: 1px solid var(--cinza-borda);
      border-radius: 12px;
      padding: 18px;
    }

    .categorias {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .categoria {
      border: 1px dashed var(--cinza-borda);
      border-radius: 10px;
      padding: 12px;
      background: #fff;
    }

    .categoria h3 {
      margin: 0 0 10px;
      color: var(--vermelho);
      font-size: 18px;
    }

    .multa {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      background: var(--cinza-claro);
      margin-bottom: 8px;
    }

    .multa .nome {
      font-weight: 600;
    }

    .multa .valor {
      font-weight: 600;
      color: #333;
      min-width: 130px;
      text-align: right;
    }

    .multa .qty {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .qty button {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: var(--vermelho);
      color: #fff;
      transition: .2s;
    }

    .qty button:hover {
      background: #a30000;
    }

    .qty input {
      width: 48px;
      text-align: center;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
    }

    .extrato h2 {
      margin: 0 0 12px;
    }

    .extrato-box {
      background: #fff;
      border: 1px solid var(--cinza-borda);
      border-radius: 10px;
      padding: 12px;
      min-height: 160px;
    }

    .extrato-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--cinza-claro);
      margin-bottom: 8px;
    }

    .extrato-item .x {
      font-weight: 700;
      color: #444
    }

    .total {
      border-top: 2px solid #eee;
      padding-top: 12px;
      margin-top: 10px;
      font-size: 18px;
      font-weight: 700;
      color: var(--vermelho);
    }

    .botoes {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .btn {
      flex: 1;
      background: var(--vermelho);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      cursor: pointer;
      font-weight: 700;
      transition: .2s;
    }

    .btn:hover {
      background: #a30000;
    }

    .btn.sec {
      background: #666;
    }

    .btn.sec:hover {
      background: #444;
    }

    @media (max-width: 1000px) {
      .content {
        grid-template-columns: 1fr;
      }

      .top-form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="conteudo">
    <h1>Calculadora de Vistoria - Bombeiros</h1>

    <!-- CAMPOS -->
    <div class="top-form card">
      <div class="form-group">
        <label>Razão Social</label>
        <input id="razao" type="text" placeholder="Ex.: Hospital Norte" oninput="atualizarExtrato()" />
      </div>
      <div class="form-group">
        <label>Responsável Legal</label>
        <input id="respLegal" type="text" placeholder="Ex.: Tony Zera" oninput="atualizarExtrato()" />
      </div>
      <div class="form-group">
        <label>ID</label>
        <input id="idPessoa" type="text" placeholder="Ex.: 108584" oninput="atualizarExtrato()" />
      </div>

      <div class="form-group">
        <label>Cargo</label>
        <input id="cargo" type="text" placeholder="Ex.: Vice Diretor" oninput="atualizarExtrato()" />
      </div>
      <div class="form-group">
        <label>Contato</label>
        <input id="contato" type="text" placeholder="Ex.: 925-719" oninput="atualizarExtrato()" />
      </div>
      <div class="form-group">
        <label>Militar Responsável</label>
        <input id="militar" type="text" placeholder="Assinatura" oninput="atualizarExtrato()" />
      </div>

      <div class="form-group">
        <label>Valor inicial da vistoria (R$)</label>
        <input id="valorInicial" type="text" value="0,00" oninput="formatarMoeda(this); atualizarExtrato();" />
      </div>
    </div>

    <div class="content">
      <!-- CATEGORIAS E MULTAS -->
      <div class="card">
        <h2 style="margin-top:0">Multas</h2>
        <div id="categorias" class="categorias"></div>
      </div>

      <!-- EXTRATO -->
      <div class="card extrato">
        <h2>Extrato</h2>
        <div id="extrato" class="extrato-box">Nenhuma vistoria registrada.</div>
        <div class="botoes">
          <button class="btn sec" onclick="limparTudo()">Limpar</button>
          <button class="btn" onclick="gerarAlvara()">Gerar Alvará (PDF)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- libs para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /*********** CONFIG ***********/
    const ALVARA_TEMPLATE_SRC = "imagens/alvara_template.png"; // coloque sua imagem do modelo aqui

    // Multas por categoria – adicione/edite aqui facilmente
    const MULTAS = {
      "Saídas de Emergência": [
        { nome: "Rotas de fuga desobstruídas", valor: 40000 },
        { nome: "Rotas de fuga iluminadas", valor: 40000 },
        { nome: "Piso íntegro e acessível", valor: 10000 },
        { nome: "Luminárias de emergência nas rotas", valor: 40000 },
      ],
      "Escadas": [
        { nome: "Escadas desobstruídas", valor: 50000 },
        { nome: "Placas e iluminação nas escadas", valor: 40000 },
        { nome: "Portas nas escadas", valor: 40000 },
      ],
      "Extintores": [
        { nome: "Extintores desobstruídos", valor: 50000 },
        { nome: "Extintores sinalizados", valor: 50000 },
        { nome: "Extintores em local apropriado", valor: 50000 },
        { nome: "Quantidade de extintores (4 ou mais)", valor: 50000 },
        { nome: "Extintores com sinais de danos", valor: 50000 },
      ],
      "Sistema de Hidrantes": [
        { nome: "Hidrantes desobstruídos e sinalizados", valor: 20000 },
        { nome: "Tubulações pintadas de vermelho", valor: 20000 },
      ],
      "Sprinklers (Chuveiros Automáticos)": [
        { nome: "Existência de sprinklers", valor: 10000 },
        { nome: "Distância correta entre chuveiros e paredes", valor: 10000 },
      ],
      "Iluminação e Sinalização": [
        { nome: "Iluminação de emergência funcionando", valor: 10000 },
        { nome: "Sinalização de emergência visível", valor: 10000 },
      ],
      "Acessibilidade": [
        { nome: "Rampas para cadeirantes", valor: 30000 },
        { nome: "Portas e corredores largos para cadeirantes", valor: 30000 },
      ],
      "Outros Itens": [
        { nome: "Material inflamável perto das saídas", valor: 50000 },
        { nome: "Cabos ou fios expostos", valor: 50000 },
      ]
    };

    // Estado das quantidades
    const qtd = {}; // chave = nome da multa -> quantidade

    /*********** HELPERS ***********/
    const fmtBRL = (v) => v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    function parseBRL(str) {
      if (!str) return 0;
      const limpo = str.replace(/\./g, "").replace(",", ".").replace(/[^0-9.]/g, "");
      const num = parseFloat(limpo);
      return isNaN(num) ? 0 : num;
    }
    function formatarMoeda(input) {
      let v = input.value.replace(/[^\d]/g, "");
      if (v === "") { input.value = "0,00"; return; }
      v = (parseInt(v, 10) / 100).toFixed(2).replace(".", ",");
      input.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    /*********** RENDER ***********/
    function montarCategorias() {
      const wrap = document.getElementById("categorias");
      wrap.innerHTML = "";
      Object.entries(MULTAS).forEach(([cat, itens]) => {
        const box = document.createElement("div");
        box.className = "categoria";
        box.innerHTML = `<h3>${cat}</h3>`;
        itens.forEach(item => {
          if (!(item.nome in qtd)) qtd[item.nome] = 0;
          const linha = document.createElement("div");
          linha.className = "multa";
          linha.innerHTML = `
            <div class="nome">${item.nome}</div>
            <div class="valor">${fmtBRL(item.valor)}</div>
            <div class="qty">
              <button type="button" aria-label="diminuir" onclick="alterarQtd('${item.nome}', -1)">−</button>
              <input type="text" value="${qtd[item.nome]}" readonly />
              <button type="button" aria-label="aumentar" onclick="alterarQtd('${item.nome}', 1)">+</button>
            </div>
          `;
          box.appendChild(linha);
        });
        wrap.appendChild(box);
      });
    }

    function alterarQtd(nome, delta) {
      const novo = Math.max(0, (qtd[nome] || 0) + delta);
      qtd[nome] = novo;
      montarCategorias();
      atualizarExtrato();
    }

    /*********** EXTRATO ***********/
    function atualizarExtrato() {
      const extrato = document.getElementById("extrato");
      const valorInicial = parseBRL(document.getElementById("valorInicial").value);
      const razao = document.getElementById("razao").value.trim();

      // montando lista de itens selecionados
      const linhas = [];
      let total = valorInicial;

      Object.entries(MULTAS).forEach(([cat, itens]) => {
        itens.forEach(item => {
          const q = qtd[item.nome] || 0;
          if (q > 0) {
            const sub = q * item.valor;
            total += sub;
            linhas.push({ nome: item.nome, q, unit: item.valor, sub });
          }
        });
      });

      if (linhas.length === 0 && !razao && valorInicial === 0) {
        extrato.innerHTML = "Nenhuma vistoria registrada.";
        return;
      }

      let html = `
        <div><strong>Razão Social:</strong> ${razao || "N/D"}</div>
        <div><strong>Valor inicial:</strong> ${fmtBRL(valorInicial)}</div>
        <br/>
      `;

      linhas.forEach(l => {
        html += `
          <div class="extrato-item">
            <span><span class="x">${l.q}×</span> ${l.nome}</span>
            <span>${fmtBRL(l.unit)} → <strong>${fmtBRL(l.sub)}</strong></span>
          </div>
        `;
      });

      html += `<div class="total"><strong>Total Final:</strong> ${fmtBRL(total)}</div>`;
      extrato.innerHTML = html;
    }

    function limparTudo() {
      Object.keys(qtd).forEach(k => qtd[k] = 0);
      document.getElementById("razao").value = "";
      document.getElementById("respLegal").value = "";
      document.getElementById("idPessoa").value = "";
      document.getElementById("cargo").value = "";
      document.getElementById("contato").value = "";
      document.getElementById("militar").value = "";
      document.getElementById("valorInicial").value = "0,00";
      montarCategorias();
      atualizarExtrato();
    }

    /*********** PDF ALVARÁ ***********/
    async function gerarAlvara() {
      const { jsPDF } = window.jspdf;

      // ---- Campos
      const razao = (document.getElementById("razao").value || "").trim();
      const resp = (document.getElementById("respLegal").value || "").trim();
      const id = (document.getElementById("idPessoa").value || "").trim();
      const cargo = (document.getElementById("cargo").value || "").trim();
      const contato = (document.getElementById("contato").value || "").trim();
      const militar = (document.getElementById("militar").value || "").trim();

      // ---- Datas
      const emissao = new Date();
      const renov = new Date(emissao); renov.setDate(emissao.getDate() + 30);
      const fmtDataHora = d => d.toLocaleString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });
      const fmtData = d => d.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric" });

      // ---- PDF
      const pdf = new jsPDF({ unit: "pt", format: "a4" });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      // Tenta carregar template como dataURL (mais compatível)
      try {
        const imgData = await carregarTemplateComoDataURL(ALVARA_TEMPLATE_SRC);
        if (imgData) {
          pdf.addImage(imgData, "PNG", 0, 0, pageW, pageH);  // cobre a página toda
        }
      } catch (e) {
        console.warn("Falha ao carregar o template do alvará:", e);
      }

      // ---- Texto (ajuste fino de posições aqui)
      pdf.setTextColor(0, 0, 0);
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(12);

      const X = 60;   // margem esquerda
      let y = 420;  // logo abaixo da linha vermelha do seu modelo

      pdf.text(`Razão social: ${razao}`, X, y); y += 22;
      pdf.text(`Data de emissão: ${fmtDataHora(emissao)}`, X, y); y += 22;
      pdf.text(`Data de renovação: ${fmtData(renov)}`, X, y); y += 22;
      pdf.text(`Responsável legal: ${resp}`, X, y); y += 22;
      pdf.text(`ID: ${id}`, X, y); y += 22;
      pdf.text(`Cargo: ${cargo}`, X, y); y += 22;
      pdf.text(`Contato: ${contato}`, X, y); y += 40;

      // Assinatura (parte de baixo à direita)
      pdf.setFontSize(14);
      pdf.text(militar || "", pageW - 220, pageH - 75, { align: "center" });

      pdf.save(`alvara_${(razao || "empresa").replace(/\\s+/g, "_")}.pdf`);
    }

    // Usa fetch → blob → dataURL (evita problemas de CORS/Imagem)
    async function carregarTemplateComoDataURL(src) {
      const res = await fetch(src);
      if (!res.ok) throw new Error(`HTTP ${res.status} ao carregar ${src}`);
      const blob = await res.blob();
      return await new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.readAsDataURL(blob);
      });
    }

    /*********** INIT ***********/
    montarCategorias();
    atualizarExtrato();
  </script>
</body>

</html>